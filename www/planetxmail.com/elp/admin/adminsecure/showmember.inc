<?php
require_once('/home/nulled/www/planetxmail.com/mle/mlpsecure/config/classes.inc');
require_once('/home/nulled/www/planetxmail.com/mle/mlpsecure/validationfunctions.php');

$db = new MySQL_Access("elp");

if ($todo=="resetpassword")
{
  if ($pass1!=""&&$pass2!="")
  {
    if ($pass1!=$pass2) $notValid = "ERROR: Passwords do not match.";
    else if (strlen($pass1)>20) $notValid = "ERROR: Passwords can not be greater then 20 chars.";
    else if (strlen($pass1)<6) $notValid = "ERROR: Password must be 6 chars minimum.";
    else if (has_space($pass1)) $notvalid = "ERROR: Password can not contain spaces.";
    else
    {
      $pass1 = md5($pass1);

      $db->Query("UPDATE users SET password='$pass1' WHERE username='$elpmember' AND elpownername='$_SESSION[aaelp]ownername'");

      $db->Query("SELECT email FROM users WHERE username='$elpmember' AND elpownername='$_SESSION[aaelp]ownername'");
      list($email) = $db->FetchRow();

      $db->Query("SELECT email FROM elpowners WHERE elpownername='$_SESSION[aaelp]ownername'");
      list($adminemail) = $db->FetchRow();

      $headers = "From: ELP <$adminemail>";
      $subject = "ELP Password was changed.";

      $message = "Your password was changed.\n\nYour ELP information is below:\n--------------------------\nUsername: $elpmember\nPassword: $pass2\nOwner: $_SESSION[aaelp]ownername\n\n______________________________\nThis message auto-generated by ELP systems.";

      @mail($email, $subject, $message, $headers);
      $notValid = "Member password changed, and email sent to them.";

      $pass1 = "";
      $pass2 = "";
    }
  }
  else
    $notValid = "ERROR: Need both password fields entered.";
}
else if ($todo=="deletemember")
{
  $db->Query("DELETE FROM users WHERE username='$elpmember' AND elpownername='$_SESSION[aaelp]ownername'");
  $db->Query("DELETE FROM ipaddresses WHERE username='$elpmember' AND elpownername='$_SESSION[aaelp]ownername'");

  if ($elpmember=="test_me" || $elpmember=="demo")
    $db->Query("DELETE FROM membertrans WHERE username='$elpmember' AND elpownername='$_SESSION[aaelp]ownername'");
  else
  {
    $newname = trim(substr($elpmember, 0, 13));
    $deleteID = generateID(2);
    $deletedusername = $newname."_GONE".$deleteID;
    $db->Query("UPDATE membertrans SET username='$deletedusername' WHERE username='$elpmember' AND elpownername='$_SESSION[aaelp]ownername'");
  }

  header("Location: main.php");
  exit;
}
else if ($todo=="changememberdata")
{
  if ($fname!=""&&$lname!=""&&$email!="")
  {
    $fname = trim($fname);
    $lname = trim($lname);
    $email = trim($email);

    if ($notValid = LengthRealname($fname)) {}
    else if ($notValid = LengthRealname($lname)) {}
    else if ($notValid = EmailFormat($email)) {}
    else
    {
      $db->Query("UPDATE users SET fname='$fname', lname='$lname', email='$email', blocked='$blocked' WHERE username='$elpmember' AND elpownername='$_SESSION[aaelp]ownername'");
      $notValid = "Member data successfully updated.";
    }
  }
  else
    $notValid = "ERROR: Missing required fields.";
}

$db->Query("SELECT username, fname, lname, email, blocked, paid, memtype FROM users WHERE username='$elpmember' AND elpownername='$_SESSION[aaelp]ownername'");
list($username, $fname, $lname, $email, $blocked, $paid, $memtype) = $db->FetchRow();

?>